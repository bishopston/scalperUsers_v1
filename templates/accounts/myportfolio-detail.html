{%  extends "../base/base.html" %}

{% block content %}

{% load index %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>

<div class="mt-2 container bg-white text-dark">
    <div class="container bg-light text-dark">
        <div class="row">
            <div class="col my-3">
                <h6><a href="{% url 'accounts:portfolio' %}">My Portfolios</a> / {{portfolio.name}}</h6>
            </div>
        </div>
    </div>
    <div class="container bg-white text-dark d-flex flex-wrap overflow-auto justify-content-start mt-2">
      <div class="row w-100">
          <div class="col-md-12">
              <ul class="nav nav-pills">
                  <li class="nav-item">
                      <a href="#summary" class="nav-link active" role="tab" data-toggle="tab">Summary</a>
                  </li>
                  <li class="nav-item">
                      <a href="#valuation" class="nav-link" role="tab" data-toggle="tab">Payoff</a>
                  </li>
              </ul>

              <div class="my-1 tab-content justify-content-center">
                      <div role="tabpanel" class="tab-pane active" id="summary">
                        <div id="accordion">
                            <div class="card mt-2">
                              <div class="card-header bg-secondary" id="headingOne">
                                <h5 class="mb-0">
                                  <button class="btn btn-link text-light" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Options
                                  </button>
                                </h5>
                              </div>
                          
                              <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordion">
                                <div class="card-body">
                                  {% if error_message %}
                                  <center><p><strong class="text-danger">{{ error_message }}</strong></p></center>
                                  {% endif %}

                                  {% for error in portfolioOptionForm.errors %}
                                  <center><p><strong class="text-danger">Please select a valid {{ error }} value</strong></p></center>
                                  {% endfor %}     

                                  
                                    {% if active_options %}
                                      <div class="container bg-white text-dark">
                                        <div class="row">
                                          <div class="table-responsive">
                                            <table class="table table-striped table-sm">
                                              <tr>
                                                <th><small><strong></strong></small></th>
                                                <th><small><strong>Symbol</strong></small></th>
                                                <th><small><strong>Option Type</strong></small></th>
                                                <th><small><strong>Position</strong></small></th>
                                                <th><small><strong>Added On</strong></small></th>
                                                <th><small><strong>Latest Trading</strong></small></th>
                                                <th><small><strong>Expiration</strong></small></th>
                                                <th><small><strong>Contracts</strong></small></th>
                                                <th><small><strong>Unit Debit/Credit</strong></small></th>
                                                <th><small><strong>Latest Value</strong></small></th>
                                                <th><small><strong>Underlying Price</strong></small></th>
                                                <th><small><strong>Exercise Profit/Loss</strong></small></th>
                                                <th><small><strong></strong></small></th>
                                              </tr>
                                              {%csrf_token%}
                                              {% for option in active_options %}
                                                <tr id="{{option.id}}">
                                                    <td><input type="checkbox" name="option_id[]" value="{{option.id}}" id="portfolio_option"></td>
                                                    <td><small>
                                                      {% if option.active_option %}
                                                        <a href="{% url 'option_pricing:option_screener_detail' option.optionsymbol.symbol %}">{{ option.optionsymbol.symbol }}</a>
                                                      {% else %}
                                                        <a href="{% url 'option_pricing:option_screener_detail' option.optionsymbol.symbol %}"><del>{{ option.optionsymbol.symbol }}</del></a>
                                                      {% endif %}
                                                    </small></td>
                                                    <td><small>{{option.optionsymbol.get_optiontype_display}}</small></td>
                                                    <td><small>{{option.position}}</small></td>  
                                                    <td><small>{{option.created_at|date:"SHORT_DATE_FORMAT"}}</small></td> 
                                                    <td><small>{{max_options_dates|index:forloop.counter0}}</small></td>
                                                    <td><small>{{option.optionsymbol.expmonthdate|date:"SHORT_DATE_FORMAT"}}</small></td>
                                                    <td><small>{{option.contracts}}</small></td>
                                                    <td><small>{{option.buysellprice}}</small></td> 
                                                    <td><small>{{options_clos_prices|index:forloop.counter0}}</small></td>  
                                                    <td><small>{{stock_prices|index:forloop.counter0}}</small></td>     
                                                    <td><small>
                                                      {% if profits|index:forloop.counter0 < 0 %}
                                                      <div class="change-negative"> 
                                                      {% else %} 
                                                      <div class="change-positive">
                                                      {% endif %}
                                                      {{ profits|index:forloop.counter0|floatformat:2 }}
                                                      </div>
                                                    </small></td> 
                                                    <td><a href="{% url 'accounts:portfolio-option-update' portfolio.id option.id %}"><i class="fa fa-pencil" aria-hidden="true"></i></a></td>
                                                </tr>

                                              {% endfor %}
                                            </table>
                                          </div>
                                        </div>
                                      </div>  
                                      
                                      <div class="d-flex justify-content-center my-1 ml-1">
                                        <button type="button" class="btn btn-outline-primary d-flex flex-wrap align-content-center" id="del_btn"><small>Delete Option</small></button>

                                        <div class="d-flex justify-content-center px-3">
                                          <button type="button" class="btn btn-primary d-flex flex-wrap align-content-center" data-toggle="modal" data-target="#optionAddModal">
                                              <small>Add Option</small> 
                                          </button>
                                        </div>
                                        <!-- Modal -->
                                        <div class="modal fade" id="optionAddModal" tabindex="-1" role="dialog" aria-labelledby="optionAddModalLabel" aria-hidden="true">
                                            <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                <h5 class="modal-title" id="optionAddModalLabel">Add Option</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                                </div>
                                                <div class="modal-body">
                                                    <form method="POST" id="optionmodalform" action=".">
                                                        {% csrf_token %}                                
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-6 mb-0">
                                                            {{ portfolioOptionForm.asset }}
                                                          </div>
                                                          <div class="form-group col-md-6 mb-0">
                                                            {% for radio in portfolioOptionForm.option_type %}
                                                              {{ radio }}
                                                            {% endfor %} 
                                                          </div>
                                                        </div>
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-6 mb-0" aria-describedby="expDateHelpBlock">
                                                            {{ portfolioOptionForm.exp_month }}
                                                          </div>
                                                          <div class="form-group col-md-6 mb-0">
                                                            {{ portfolioOptionForm.exp_year}}
                                                          </div>
                                                          <div class="ml-2"> 
                                                            <small id="expDateHelpBlock" class="form-text text-muted">
                                                              Please select an active option
                                                            </small>
                                                          </div>
                                                        </div>
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-12 mb-0" aria-describedby="strikeHelpBlock">
                                                            {{ portfolioOptionForm.strike }}
                                                          </div>
                                                          <div class="ml-2"> 
                                                            <small id="strikeHelpBlock" class="form-text text-muted">
                                                              Please select either an integer or decimal number (use dot as a separator)
                                                            </small>
                                                          </div>
                                                        </div>
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-12 mb-0" aria-describedby="positionTypeHelpInline">
                                                            {% for radio in portfolioOptionForm.position_type %}
                                                              {{ radio }}
                                                            {% endfor %}
                                                            <small id="positionTypeHelpInline" class="text-muted ml-2">
                                                              Please select the type of position
                                                            </small>
                                                          </div>
                                                        </div>
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-12 mb-0">
                                                            {{ portfolioOptionForm.contracts }}
                                                          </div>
                                                          <div class="ml-2"> 
                                                            <small id="buySellPriceHelpBlock" class="form-text text-muted">
                                                              Please select an integer value
                                                            </small>
                                                          </div>
                                                        </div>
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-12 mb-0" aria-describedby="buySellPriceHelpBlock">
                                                            {{ portfolioOptionForm.buysellprice}}
                                                          </div>
                                                          <div class="ml-2"> 
                                                            <small id="buySellPriceHelpBlock" class="form-text text-muted">
                                                              Please select either an integer or decimal number (use dot as a separator)
                                                            </small>
                                                          </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-primary" name="option_button">Add to {{portfolio.name}}</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                            </div>
                                        </div>

                                      </div>

                                    {% else %}
                                        <div class="col-md-12 d-flex justify-content-center">
                                            <div class="card border-0">
                                                <div class="card-body">
                                                    <p class="card-text d-flex justify-content-center">{{portfolio.name}} does not contain any active options. Add option symbols to your portfolio.</p>                       
                                                </div>
                                                <div class="row d-flex justify-content-center mb-3">
                                                  <button type="button" class="btn btn-primary d-flex flex-wrap align-content-center" data-toggle="modal" data-target="#optionAddModal">
                                                      <small>Add option</small> 
                                                  </button>
                                                  
                                                  <!-- Modal -->
                                                  <div class="modal fade" id="optionAddModal" tabindex="-1" role="dialog" aria-labelledby="optionAddModalLabel" aria-hidden="true">
                                                      <div class="modal-dialog" role="document">
                                                      <div class="modal-content">
                                                          <div class="modal-header">
                                                          <h5 class="modal-title" id="optionAddModalLabel">Add Option</h5>
                                                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                              <span aria-hidden="true">&times;</span>
                                                          </button>
                                                          </div>
                                                          <div class="modal-body">
                                                            <form method="POST" id="optionmodalform" action=".">
                                                              {% csrf_token %}                                
                                                              <div class="form-row mb-2">
                                                                <div class="form-group col-md-6 mb-0">
                                                                  {{ portfolioOptionForm.asset }}
                                                                </div>
                                                                <div class="form-group col-md-6 mb-0">
                                                                  {% for radio in portfolioOptionForm.option_type %}
                                                                    {{ radio }}
                                                                  {% endfor %} 
                                                                </div>
                                                              </div>
                                                              <div class="form-row mb-2">
                                                                <div class="form-group col-md-6 mb-0" aria-describedby="expDateHelpBlock">
                                                                  {{ portfolioOptionForm.exp_month }}
                                                                </div>
                                                                <div class="form-group col-md-6 mb-0">
                                                                  {{ portfolioOptionForm.exp_year}}
                                                                </div>
                                                                <div class="ml-2"> 
                                                                  <small id="expDateHelpBlock" class="form-text text-muted">
                                                                    Please select an active option
                                                                  </small>
                                                                </div>
                                                              </div>
                                                              <div class="form-row mb-2">
                                                                <div class="form-group col-md-12 mb-0" aria-describedby="strikeHelpBlock">
                                                                  {{ portfolioOptionForm.strike }}
                                                                </div>
                                                                <div class="ml-2"> 
                                                                  <small id="strikeHelpBlock" class="form-text text-muted">
                                                                    Please select either an integer or decimal number (use dot as a separator)
                                                                  </small>
                                                                </div>
                                                              </div>
                                                              <div class="form-row mb-2">
                                                                <div class="form-group col-md-12 mb-0" aria-describedby="positionTypeHelpInline">
                                                                  {% for radio in portfolioOptionForm.position_type %}
                                                                    {{ radio }}
                                                                  {% endfor %}
                                                                  <small id="positionTypeHelpInline" class="text-muted ml-2">
                                                                    Please select the type of position
                                                                  </small>
                                                                </div>
                                                              </div>
                                                              <div class="form-row mb-2">
                                                                <div class="form-group col-md-12 mb-0">
                                                                  {{ portfolioOptionForm.contracts }}
                                                                </div>
                                                                <div class="ml-2"> 
                                                                  <small id="buySellPriceHelpBlock" class="form-text text-muted">
                                                                    Please select an integer value
                                                                  </small>
                                                                </div>
                                                              </div>
                                                              <div class="form-row mb-2">
                                                                <div class="form-group col-md-12 mb-0" aria-describedby="buySellPriceHelpBlock">
                                                                  {{ portfolioOptionForm.buysellprice}}
                                                                </div>
                                                                <div class="ml-2"> 
                                                                  <small id="buySellPriceHelpBlock" class="form-text text-muted">
                                                                    Please select either an integer or decimal number (use dot as a separator)
                                                                  </small>
                                                                </div>
                                                              </div>
                                                              <div class="modal-footer">
                                                              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                              <button type="submit" class="btn btn-primary" name="option_button">Add to {{portfolio.name}}</button>
                                                              </div>
                                                          </form>
                                                          </div>
                                                      </div>
                                                      </div>
                                                  </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                              </div>
                            </div>
                            <div class="card">
                              <div class="card-header bg-secondary" id="headingTwo">
                                <h5 class="mb-0">
                                  <button class="btn btn-link collapsed text-light" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    Futures
                                  </button>
                                </h5>
                              </div>
                              <div id="collapseTwo" class="collapse show" aria-labelledby="headingTwo" data-parent="#accordion">
                                <div class="card-body">
                                    {% if error_future_message %}
                                    <center><p><strong class="text-danger">{{ error_future_message }}</strong></p></center>
                                    {% endif %}

                                    {% for error in portfolioFutureForm.errors %}
                                    <center><p><strong class="text-danger">Please select a valid {{ error }} value</strong></p></center>
                                    {% endfor %}                

                                    {% if active_futures %}
                                      <div class="container bg-white text-dark">
                                        <div class="row">
                                          <div class="table-responsive">
                                            <table class="table table-striped table-sm">
                                              <tr>
                                                <th><small><strong></strong></small></th>
                                                <th><small><strong>Symbol</strong></small></th>
                                                <th><small><strong>Position</strong></small></th>
                                                <th><small><strong>Added On</strong></small></th>
                                                <th><small><strong>Latest Trading</strong></small></th>
                                                <th><small><strong>Expiration</strong></small></th>
                                                <th><small><strong>Contracts</strong></small></th>
                                                <th><small><strong>Unit Debit/Credit</strong></small></th>
                                                <th><small><strong>Latest Value</strong></small></th>
                                                <th><small><strong>Underlying Price</strong></small></th>
                                                <th><small><strong>Unit Exercise Profit/Loss</strong></small></th>
                                                <th><small><strong></strong></small></th>
                                              </tr>
                                              {%csrf_token%}
                                              {% for future in active_futures %}
                                                <tr id="{{future.id}}">
                                                    <td><input type="checkbox" name="future_id[]" value="{{future.id}}" id="portfolio_future"></td>
                                                    <td><small>
                                                      {% if future.active_future %}
                                                        <a href="{% url 'option_pricing:future_screener_detail' future.futuresymbol.symbol %}">{{ future.futuresymbol.symbol }}</a>
                                                      {% else %}
                                                        <a href="{% url 'option_pricing:future_screener_detail' future.futuresymbol.symbol %}"><del>{{ future.futuresymbol.symbol }}</del></a>
                                                      {% endif %}
                                                    </small></td>
                                                    <td><small>{{future.position}}</small></td>  
                                                    <td><small>{{future.created_at|date:"SHORT_DATE_FORMAT"}}</small></td> 
                                                    <td><small>{{max_futures_dates|index:forloop.counter0}}</small></td>
                                                    <td><small>{{future.futuresymbol.expmonthdate|date:"SHORT_DATE_FORMAT"}}</small></td>
                                                    <td><small>{{future.contracts}}</small></td>
                                                    <td><small>{{future.buysellprice}}</small></td> 
                                                    <td><small>{{futures_clos_prices|index:forloop.counter0}}</small></td>  
                                                    <td><small>{{futures_stock_prices|index:forloop.counter0}}</small></td>     
                                                    <td><small>
                                                      {% if futures_profits|index:forloop.counter0 < 0 %}
                                                      <div class="change-negative"> 
                                                      {% else %} 
                                                      <div class="change-positive">
                                                      {% endif %}
                                                      {{ futures_profits|index:forloop.counter0|floatformat:2 }}
                                                      </div>
                                                    </small></td> 
                                                    <td><a href="{% url 'accounts:portfolio-future-update' portfolio.id future.id %}"><i class="fa fa-pencil" aria-hidden="true"></i></a></td>
                                                </tr>

                                              {% endfor %}
                                            </table>
                                          </div>
                                        </div>
                                      </div>  
                                      
                                      <div class="d-flex justify-content-center my-1 ml-1">
                                        <button type="button" class="btn btn-outline-primary d-flex flex-wrap align-content-center" id="del_fut_btn"><small>Delete Future</small></button>

                                        <div class="d-flex justify-content-center px-3">
                                          <button type="button" class="btn btn-primary d-flex flex-wrap align-content-center" data-toggle="modal" data-target="#futureAddModal">
                                              <small>Add Future</small> 
                                          </button>
                                        </div>
                                        <!-- Modal -->
                                        <div class="modal fade" id="futureAddModal" tabindex="-1" role="dialog" aria-labelledby="futureAddModalLabel" aria-hidden="true">
                                            <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                <h5 class="modal-title" id="futureAddModalLabel">Add Future</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                                </div>
                                                <div class="modal-body">
                                                    <form method="POST" id="futuremodalform" action='{% url "accounts:portfolio-future-detail" portfolio.id %}'>
                                                        {% csrf_token %}                                
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-6 mb-0">
                                                            {{ portfolioFutureForm.asset }}
                                                          </div>
                                                        </div>
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-6 mb-0" aria-describedby="expDateHelpBlock">
                                                            {{ portfolioFutureForm.exp_month }}
                                                          </div>
                                                          <div class="form-group col-md-6 mb-0">
                                                            {{ portfolioFutureForm.exp_year}}
                                                          </div>
                                                          <div class="ml-2"> 
                                                            <small id="expDateHelpBlock" class="form-text text-muted">
                                                              Please select an active future
                                                            </small>
                                                          </div>
                                                        </div>
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-12 mb-0" aria-describedby="positionTypeHelpInline">
                                                            {% for radio in portfolioFutureForm.position_type %}
                                                              {{ radio }}
                                                            {% endfor %}
                                                            <small id="positionTypeHelpInline" class="text-muted ml-2">
                                                              Please select the type of position
                                                            </small>
                                                          </div>
                                                        </div>
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-12 mb-0">
                                                            {{ portfolioFutureForm.contracts }}
                                                          </div>
                                                          <div class="ml-2"> 
                                                            <small id="buySellPriceHelpBlock" class="form-text text-muted">
                                                              Please select an integer value
                                                            </small>
                                                          </div>
                                                        </div>
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-12 mb-0" aria-describedby="buySellPriceHelpBlock">
                                                            {{ portfolioFutureForm.buysellprice}}
                                                          </div>
                                                          <div class="ml-2"> 
                                                            <small id="buySellPriceHelpBlock" class="form-text text-muted">
                                                              Please select either an integer or decimal number (use dot as a separator)
                                                            </small>
                                                          </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-primary" name="future_button">Add to {{portfolio.name}}</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                            </div>
                                        </div>

                                      </div>

                                    {% else %}
                                        <div class="col-md-12 d-flex justify-content-center">
                                            <div class="card border-0">
                                                <div class="card-body">
                                                    <p class="card-text d-flex justify-content-center">{{portfolio.name}} does not contain any active futures. Add future symbols to your portfolio.</p>                       
                                                </div>
                                                <div class="row d-flex justify-content-center mb-3">
                                                  <button type="button" class="btn btn-primary d-flex flex-wrap align-content-center" data-toggle="modal" data-target="#futureAddModal">
                                                      <small>Add Future</small> 
                                                  </button>
                                                  
                                                  <!-- Modal -->
                                    <div class="modal fade" id="futureAddModal" tabindex="-1" role="dialog" aria-labelledby="futureAddModalLabel" aria-hidden="true">
                                      <div class="modal-dialog" role="document">
                                      <div class="modal-content">
                                        <div class="modal-header">
                                        <h5 class="modal-title" id="futureAddModalLabel">Add Future</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                          <span aria-hidden="true">&times;</span>
                                        </button>
                                        </div>
                                        <div class="modal-body">
                                          <form method="POST" id="futuremodalform" action='{% url "accounts:portfolio-future-detail" portfolio.id %}'>
                                            {% csrf_token %}                                
                                            <div class="form-row mb-2">
                                              <div class="form-group col-md-6 mb-0">
                                              {{ portfolioFutureForm.asset }}
                                              </div>
                                            </div>
                                            <div class="form-row mb-2">
                                              <div class="form-group col-md-6 mb-0" aria-describedby="expDateHelpBlock">
                                              {{ portfolioFutureForm.exp_month }}
                                              </div>
                                              <div class="form-group col-md-6 mb-0">
                                              {{ portfolioFutureForm.exp_year}}
                                              </div>
                                              <div class="ml-2"> 
                                              <small id="expDateHelpBlock" class="form-text text-muted">
                                                Please select an active future
                                              </small>
                                              </div>
                                            </div>
                                            <div class="form-row mb-2">
                                              <div class="form-group col-md-12 mb-0" aria-describedby="positionTypeHelpInline">
                                              {% for radio in portfolioFutureForm.position_type %}
                                                {{ radio }}
                                              {% endfor %}
                                              <small id="positionTypeHelpInline" class="text-muted ml-2">
                                                Please select the type of position
                                              </small>
                                              </div>
                                            </div>
                                            <div class="form-row mb-2">
                                              <div class="form-group col-md-12 mb-0">
                                              {{ portfolioFutureForm.contracts }}
                                              </div>
                                              <div class="ml-2"> 
                                              <small id="buySellPriceHelpBlock" class="form-text text-muted">
                                                Please select an integer value
                                              </small>
                                              </div>
                                            </div>
                                            <div class="form-row mb-2">
                                              <div class="form-group col-md-12 mb-0" aria-describedby="buySellPriceHelpBlock">
                                              {{ portfolioFutureForm.buysellprice}}
                                              </div>
                                              <div class="ml-2"> 
                                              <small id="buySellPriceHelpBlock" class="form-text text-muted">
                                                Please select either an integer or decimal number (use dot as a separator)
                                              </small>
                                              </div>
                                            </div>
                                            <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-primary" name="future_button">Add to {{portfolio.name}}</button>
                                            </div>
                                          </form>
                                        </div>
                                      </div>
                                      </div>
                                    </div>
                                  </div>
                              </div>
                          </div>
                                    {% endif %}
                                </div>
                              </div>
                            </div>
                            <div class="card">
                              <div class="card-header bg-secondary" id="headingThree">
                                <h5 class="mb-0">
                                  <button class="btn btn-link collapsed text-light" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                    Stocks
                                  </button>
                                </h5>
                              </div>
                              <div id="collapseThree" class="collapse show" aria-labelledby="headingThree" data-parent="#accordion">
                                <div class="card-body">
                                    {% if error_stock_message %}
                                    <center><p><strong class="text-danger">{{ error_stock_message }}</strong></p></center>
                                    {% endif %}

                                    {% for error in portfolioStockForm.errors %}
                                    <center><p><strong class="text-danger">Please select a valid {{ error }} value</strong></p></center>
                                    {% endfor %}                

                                    {% if stocks %}
                                      <div class="container bg-white text-dark">
                                        <div class="row">
                                          <div class="table-responsive">
                                            <table class="table table-striped table-sm">
                                              <tr>
                                                <th><small><strong></strong></small></th>
                                                <th><small><strong>Asset</strong></small></th>
                                                <th><small><strong>Added On</strong></small></th>
                                                <th><small><strong>Latest Trading</strong></small></th>
                                                <th><small><strong>Quantity</strong></small></th>
                                                <th><small><strong>Unit Debit</strong></small></th>
                                                <th><small><strong>Latest Price</strong></small></th>
                                                <th><small><strong>Unit Exercise Profit/Loss</strong></small></th>
                                                <th><small><strong></strong></small></th>
                                              </tr>
                                              {%csrf_token%}
                                              {% for stock in stocks %}
                                                <tr id="{{stock.id}}">
                                                    <td><input type="checkbox" name="stock_id[]" value="{{stock.id}}" id="portfolio_stock"></td>
                                                    <td><small>{{ stock.stocksymbol.get_asset_display }}</small></td>                                 
                                                    <td><small>{{stock.created_at|date:"SHORT_DATE_FORMAT"}}</small></td> 
                                                    <td><small>{{max_stocks_dates|index:forloop.counter0}}</small></td>
                                                    <td><small>{{stock.quantity}}</small></td>
                                                    <td><small>{{stock.buyprice}}</small></td> 
                                                    <td><small>{{stock_stock_prices|index:forloop.counter0}}</small></td>     
                                                    <td><small>
                                                      {% if stocks_profits|index:forloop.counter0 < 0 %}
                                                      <div class="change-negative"> 
                                                      {% else %} 
                                                      <div class="change-positive">
                                                      {% endif %}
                                                      {{ stocks_profits|index:forloop.counter0|floatformat:2 }}
                                                      </div>
                                                    </small></td> 
                                                    <td><a href="{% url 'accounts:portfolio-stock-update' portfolio.id stock.id %}"><i class="fa fa-pencil" aria-hidden="true"></i></a></td>
                                                </tr>

                                              {% endfor %}
                                            </table>
                                          </div>
                                        </div>
                                      </div>  
                                      
                                      <div class="d-flex justify-content-center my-1 ml-1">
                                        <button type="button" class="btn btn-outline-primary d-flex flex-wrap align-content-center" id="del_stock_btn"><small>Delete Stock</small></button>

                                        <div class="d-flex justify-content-center px-3">
                                          <button type="button" class="btn btn-primary d-flex flex-wrap align-content-center" data-toggle="modal" data-target="#stockAddModal">
                                              <small>Add Stock</small> 
                                          </button>
                                        </div>
                                        <!-- Modal -->
                                        <div class="modal fade" id="stockAddModal" tabindex="-1" role="dialog" aria-labelledby="stockAddModalLabel" aria-hidden="true">
                                            <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                <h5 class="modal-title" id="stockAddModalLabel">Add Stock</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                                </div>
                                                <div class="modal-body">
                                                    <form method="POST" id="stockmodalform" action='{% url "accounts:portfolio-stock-detail" portfolio.id %}'>
                                                        {% csrf_token %}                                
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-12 mb-0">
                                                            {{ portfolioStockForm.asset }}
                                                          </div>
                                                        </div>
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-12 mb-0">
                                                            {{ portfolioStockForm.quantity }}
                                                          </div>
                                                          <div class="ml-2"> 
                                                            <small id="quantityHelpBlock" class="form-text text-muted">
                                                              Please select an integer value
                                                            </small>
                                                          </div>
                                                        </div>
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-12 mb-0" aria-describedby="buyPriceHelpBlock">
                                                            {{ portfolioStockForm.buyprice}}
                                                          </div>
                                                          <div class="ml-2"> 
                                                            <small id="buyPriceHelpBlock" class="form-text text-muted">
                                                              Please select either an integer or decimal number (use dot as a separator)
                                                            </small>
                                                          </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-primary" name="stock_button">Add to {{portfolio.name}}</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                            </div>
                                        </div>

                                      </div>

                                    {% else %}
                                        <div class="col-md-12 d-flex justify-content-center">
                                            <div class="card border-0">
                                                <div class="card-body">
                                                    <p class="card-text d-flex justify-content-center">{{portfolio.name}} does not contain any stocks. Add stocks to your portfolio.</p>                       
                                                </div>
                                                <div class="row d-flex justify-content-center mb-3">
                                                  <button type="button" class="btn btn-primary d-flex flex-wrap align-content-center" data-toggle="modal" data-target="#stockAddModal">
                                                      <small>Add Stock</small> 
                                                  </button>
                                                  
                                                  <!-- Modal -->
                                                <div class="modal fade" id="stockAddModal" tabindex="-1" role="dialog" aria-labelledby="stockAddModalLabel" aria-hidden="true">
                                                  <div class="modal-dialog" role="document">
                                                  <div class="modal-content">
                                                    <div class="modal-header">
                                                    <h5 class="modal-title" id="stockAddModalLabel">Add Stock</h5>
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                      <span aria-hidden="true">&times;</span>
                                                    </button>
                                                    </div>
                                                    <div class="modal-body">
                                                      <form method="POST" id="stockmodalform" action='{% url "accounts:portfolio-stock-detail" portfolio.id %}'>
                                                        {% csrf_token %}                                
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-12 mb-0">
                                                          {{ portfolioStockForm.asset }}
                                                          </div>
                                                        </div>
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-12 mb-0">
                                                          {{ portfolioStockForm.quantity }}
                                                          </div>
                                                          <div class="ml-2"> 
                                                          <small id="quantityHelpBlock" class="form-text text-muted">
                                                            Please select an integer value
                                                          </small>
                                                          </div>
                                                        </div>
                                                        <div class="form-row mb-2">
                                                          <div class="form-group col-md-12 mb-0" aria-describedby="buyPriceHelpBlock">
                                                          {{ portfolioStockForm.buyprice}}
                                                          </div>
                                                          <div class="ml-2"> 
                                                          <small id="buyPriceHelpBlock" class="form-text text-muted">
                                                            Please select either an integer or decimal number (use dot as a separator)
                                                          </small>
                                                          </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-primary" name="stock_button">Add to {{portfolio.name}}</button>
                                                        </div>
                                                      </form>
                                                    </div>
                                                  </div>
                                                  </div>
                                                </div>
                                  </div>
                              </div>
                          </div>
                                    {% endif %}
                                </div>
                              </div>
                            </div>
                        </div>
                      </div>
                      <div role="tabpanel" class="tab-pane" id="valuation">
                        <div class="row">
                          <div class="col-md-4">
                                <div class="table-responsive">
                                  <table class="table table-sm table-bordered mt-2">
                                    <thead>
                                      <tr class="bg-secondary text-white">
                                        <th colspan="2"><center>Portfolio performance as of {{ today|date:"SHORT_DATE_FORMAT" }}</center></th>
                                      </tr>
                                    </thead>
                                      <tr>
                                        <td>Active Options</th>
                                        <td>{{active_options_count}}</td>
                                      </tr>
                                      <tr>
                                        <td>Active Futures</td>
                                        <td>{{active_futures_count}}</td>
                                      </tr>
                                      <tr>
                                        <td>Stocks</td>
                                        <td>{{stocks_count}}</td>
                                      </tr>
                                      <tr>
                                        <td>Total Valuation (€)</td>
                                        <td>{{total_portfolio_valuation|floatformat:2}}</td>
                                      </tr>
                                      <tr>
                                        <td>Total Payoff (€)</td>
                                        <td>
                                          {% if total_portfolio_payoff < 0 %}
                                          <div class="change-negative"> 
                                          {% else %} 
                                          <div class="change-positive">
                                          {% endif %}
                                          {{total_portfolio_payoff|floatformat:2}}
                                          </div>
                                        </td>
                                      </tr>
                                  </table>
                                </div>

                          </div>
                          <div class="col-md-8">
                            <div id="accordion">
                              <div class="card mt-2">
                                <div class="card-header" id="headingOne">
                                  <h5 class="mb-0">
                                    <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                      Active Options Analysis
                                    </button>
                                  </h5>
                                </div>
                            
                                <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordion">
                                  <div class="card-body">
                                    <div class="table-responsive">
                                      <table class="table table-sm">
                                        <thead>
                                          <tr>
                                            <th scope="col"><small><strong>Symbol</strong></small></th>
                                            <th scope="col"><small><strong>Contracts</strong></small></th>
                                            <th scope="col"><small><strong>Debit/Credit (€)</strong></small></th>
                                            <th scope="col"><small><strong>Valuation (€)</strong></small></th>
                                            <th scope="col"><small><strong>Payoff (€)</strong></small></th>
                                            <th scope="col"><small><strong>Position Delta</strong></small></th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {% for item in active_options %}
                                            <tr>
                                              <td><small>{{item.optionsymbol.symbol}}</small></td>
                                              <td><small>{{item.contracts}}</small></td>
                                              <td><small>{{option_debit_credit|index:forloop.counter0|floatformat:2}}</small></td>
                                              <td><small>{{option_valuation|index:forloop.counter0|floatformat:2}}</small></td> 
                                              <td><small>{{option_payoff|index:forloop.counter0|floatformat:2}}</small></td> 
                                              <td><small>{{option_delta|index:forloop.counter0|floatformat:2}}</small></td>  
                                            </tr>
                                          {% endfor %}
                                          <tr>
                                            <th scope="col"><small><strong>Total</strong></small></th>
                                            <th scope="col"><small><strong>{{total_option_contracts|floatformat:0}}</strong></small></th>
                                            <th scope="col"><small><strong>{{total_option_debit_credit|floatformat:2}}</strong></small></th>
                                            <th scope="col"><small><strong>{{total_option_valuation|floatformat:2}}</strong></small></th>
                                            {% if total_option_payoff < 0 %}
                                              <th scope="col" class="change-negative"><small><strong>
                                                {{total_option_payoff|floatformat:2}}
                                              </strong></small></th>
                                            {% else %} 
                                              <th scope="col" class="change-positive"><small><strong>
                                                {{total_option_payoff|floatformat:2}}
                                              </strong></small></th>
                                            {% endif %}
                                            <th scope="col"><small><strong>{{total_option_delta|floatformat:2}}</strong></small></th>
                                          </tr>
                                        </tbody>
                                      </table>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="card">
                                <div class="card-header" id="headingTwo">
                                  <h5 class="mb-0">
                                    <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                      Active Futures Analysis
                                    </button>
                                  </h5>
                                </div>
                                <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion">
                                  <div class="card-body">
                                    <div class="table-responsive">
                                      <table class="table table-sm">
                                        <thead>
                                          <tr>
                                            <th scope="col"><small><strong>Symbol</strong></small></th>
                                            <th scope="col"><small><strong>Contracts</strong></small></th>
                                            <th scope="col"><small><strong>Debit/Credit (€)</strong></small></th>
                                            <th scope="col"><small><strong>Valuation (€)</strong></small></th>
                                            <th scope="col"><small><strong>Payoff (€)</strong></small></th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {% for future in active_futures %}
                                            <tr>
                                              <td><small>{{future.futuresymbol.symbol}}</small></td>
                                              <td><small>{{future.contracts}}</small></td>
                                              <td><small>{{future_debit_credit|index:forloop.counter0|floatformat:2}}</small></td>
                                              <td><small>{{future_valuation|index:forloop.counter0|floatformat:2}}</small></td> 
                                              <td><small>{{future_payoff|index:forloop.counter0|floatformat:2}}</small></td>  
                                            </tr>
                                          {% endfor %}
                                          <tr>
                                            <th scope="col"><small><strong>Total</strong></small></th>
                                            <th scope="col"><small><strong>{{total_future_contracts|floatformat:0}}</strong></small></th>
                                            <th scope="col"><small><strong>{{total_future_debit_credit|floatformat:2}}</strong></small></th>
                                            <th scope="col"><small><strong>{{total_future_valuation|floatformat:2}}</strong></small></th>
                                            {% if total_future_payoff < 0 %}
                                              <th scope="col" class="change-negative"><small><strong>
                                                {{total_future_payoff|floatformat:2}}
                                              </strong></small></th>
                                            {% else %} 
                                              <th scope="col" class="change-positive"><small><strong>
                                                {{total_future_payoff|floatformat:2}}
                                              </strong></small></th>
                                            {% endif %}
                                          </tr>
                                        </tbody>
                                      </table>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="card">
                                <div class="card-header" id="headingThree">
                                  <h5 class="mb-0">
                                    <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                      Stocks Analysis
                                    </button>
                                  </h5>
                                </div>
                                <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordion">
                                  <div class="card-body">
                                    <div class="table-responsive">
                                      <table class="table table-sm">
                                        <thead>
                                          <tr>
                                            <th scope="col"><small><strong>Stock</strong></small></th>
                                            <th scope="col"><small><strong>Quantity</strong></small></th>
                                            <th scope="col"><small><strong>Debit (€)</strong></small></th>
                                            <th scope="col"><small><strong>Valuation (€)</strong></small></th>
                                            <th scope="col"><small><strong>Payoff (€)</strong></small></th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {% for item in stocks %}
                                            <tr>
                                              <td><small>{{item.stocksymbol.get_asset_display}}</small></td>
                                              <td><small>{{item.quantity}}</small></td>
                                              <td><small>{{stock_debit_credit|index:forloop.counter0|floatformat:2}}</small></td>
                                              <td><small>{{stocks_valuation|index:forloop.counter0|floatformat:2}}</small></td> 
                                              <td><small>{{stocks_total_payoff|index:forloop.counter0|floatformat:2}}</small></td>  
                                            </tr>
                                          {% endfor %}
                                          <tr>
                                            <th scope="col"><small><strong>Total</strong></small></th>
                                            <th scope="col"><small><strong>{{stocks_quantity|floatformat:0}}</strong></small></th>
                                            <th scope="col"><small><strong>{{total_stock_debit_credit|floatformat:2}}</strong></small></th>
                                            <th scope="col"><small><strong>{{total_stock_valuation|floatformat:2}}</strong></small></th>
                                            {% if total_stock_payoff < 0 %}
                                              <th scope="col" class="change-negative"><small><strong>
                                                {{total_stock_payoff|floatformat:2}}
                                              </strong></small></th>
                                            {% else %} 
                                              <th scope="col" class="change-positive"><small><strong>
                                                {{total_stock_payoff|floatformat:2}}
                                              </strong></small></th>
                                            {% endif %}
                                          </tr>
                                        </tbody>
                                      </table>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="row mt-4">
                          <div class="col-md-12 d-flex justify-content-center">
                            <div class="w-100">
                            <nav aria-label="breadcrumb">
                              <ol class="breadcrumb bg-secondary">
                                <li class="breadcrumb-item active text-white" aria-current="page"><center><strong>Portfolio Valuation as of {{ today|date:"SHORT_DATE_FORMAT" }}</strong></center></li>
                              </ol>
                            </nav>
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12">
                            <div>
                              <canvas id="portfolioValuationChart" width="300" height="150"></canvas>
                            </div>
                            <div class="btn-group-vertical mt-3 mx-2">    
                            </div>
                          </div>
                        </div>
                      </div>
              </div>
          </div>
      </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script>
    $(document).ready(function(){
        $('#del_btn').click(function(){

                var id=[];
                var portfolio_id="{{portfolio.id}}";
                var csrf=$('input[name=csrfmiddlewaretoken]').val();
                $(':checkbox:checked').each(function(i){
                    id[i]=$(this).val()
                })
                if(id.length===0){
                    alert("Please select at least one option to delete")
                }else{
                    console.log(id)
                    console.log(portfolio_id)
                    $.ajax({
                        url:'{% url "accounts:portfolio-option-delete" %}',
                        method:"POST",
                        data:{
                            id,
                            portfolio_id,
                            csrfmiddlewaretoken:csrf
                        },
                        success:function(response){
                            for (var i=0; i < id.length; i++){
                                $('tr#'+id[i]+'').css('background-color', '#ccc');
                                $('tr#'+id[i]+'').fadeOut('slow');
                            }
                        }
                    })
                }
                $( 'input[type="checkbox"]' ).prop('checked', false);
        })
    })
</script>

<script>
  $(document).ready(function(){
      $('#del_fut_btn').click(function(){

              var id=[];
              var portfolio_id="{{portfolio.id}}";
              var csrf=$('input[name=csrfmiddlewaretoken]').val();
              $(':checkbox:checked').each(function(i){
                  id[i]=$(this).val()
              })
              if(id.length===0){
                  alert("Please select at least one future to delete")
              }else{
                  console.log(id)
                  console.log(portfolio_id)
                  $.ajax({
                      url:'{% url "accounts:portfolio-future-delete" %}',
                      method:"POST",
                      data:{
                          id,
                          portfolio_id,
                          csrfmiddlewaretoken:csrf
                      },
                      success:function(response){
                          for (var i=0; i < id.length; i++){
                              $('tr#'+id[i]+'').css('background-color', '#ccc');
                              $('tr#'+id[i]+'').fadeOut('slow');
                          }
                      }
                  })
              }
              $( 'input[type="checkbox"]' ).prop('checked', false);
      })
  })
</script>

<script>
  $(document).ready(function(){
      $('#del_stock_btn').click(function(){

              var id=[];
              var portfolio_id="{{portfolio.id}}";
              var csrf=$('input[name=csrfmiddlewaretoken]').val();
              $(':checkbox:checked').each(function(i){
                  id[i]=$(this).val()
              })
              if(id.length===0){
                  alert("Please select at least one stock to delete")
              }else{
                  console.log(id)
                  console.log(portfolio_id)
                  $.ajax({
                      url:'{% url "accounts:portfolio-stock-delete" %}',
                      method:"POST",
                      data:{
                          id,
                          portfolio_id,
                          csrfmiddlewaretoken:csrf
                      },
                      success:function(response){
                          for (var i=0; i < id.length; i++){
                              $('tr#'+id[i]+'').css('background-color', '#ccc');
                              $('tr#'+id[i]+'').fadeOut('slow');
                          }
                      }
                  })
              }
              $( 'input[type="checkbox"]' ).prop('checked', false);
      })
  })
</script>

<script>

  var portfolio_id="{{portfolio.id}}";
  var dataportfolioval = `/accounts/portfolio-valuation/${portfolio_id}/`

  var state ={
    'items':[],
    'values':[],
    'coloR':[],
  }

  $.ajax({
        method: "GET",
        url: dataportfolioval,
        success: function(response){
            // var coloR = [];
            var dynamicColors = function() {
            var r = Math.floor(Math.random() * 255);
            var g = Math.floor(Math.random() * 255);
            var b = Math.floor(Math.random() * 255);
            return "rgb(" + r + "," + g + "," + b + ")";
            };
            for (var i in response){
                var key = Object.keys(response[i])[0]
                var value = Object.values(response[i])[0]
              
            state.items.push(key)
            state.values.push(value)
            state.coloR.push(dynamicColors());
            }
            console.log(state.items)
            console.log(state.values)
            setChart()
        },
        error: function(error_data){
            console.log("error")
            console.log(error_data)
        }
  })

  function setChart(){

    var ctx = document.getElementById("portfolioValuationChart").getContext('2d');
    
    var portfolioValuationChart = new Chart(ctx, {
    
    responsive: true,
    type: 'pie',
    data: {
        labels: state.items,
        datasets: [{
            label: 'Portfolio Valuation Distribution',
            data: state.values,
            yAxisID: 'A',
            borderWidth: 1,
            backgroundColor: state.coloR,
            borderColor: 'rgba(200, 200, 200, 0.75)',
            fill: true,
            order: 1
        },
        ]
    },
    options: {
      plugins: {
        tooltip: {
          mode: 'label',
          callbacks: {
            label: function (context) {
              var label = context.dataset.label || '';
              if (context.parsed.y !== null) {
                label += '€';
              }
              return label;
            }
          }
        }
      }
    },
    })
  }

</script>

{% endblock %}